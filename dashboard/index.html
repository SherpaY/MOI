<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Opportunity Index - Pest Control Expansion Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- ====== TOP NAVIGATION ====== -->
  <nav class="top-nav">
    <div class="nav-brand">
      <h1>Market Opportunity Index</h1>
      <span class="brand-tag">Pest Control</span>
    </div>
    <div class="nav-controls">
      <div class="data-mode-toggle">
        <button class="active" data-mode="states">States (50)</button>
        <button data-mode="cities">Cities (11)</button>
      </div>
      <div class="view-toggle">
        <button class="active" data-view="composite" title="Clean summary: Rank, MOI score with bar, Population, Firms">Overview</button>
        <button data-view="component" title="Expanded: shows all 4 sub-scores (Market Size, Opportunity Gap, Pest Risk, Growth)">Score Breakdown</button>
      </div>
    </div>
  </nav>

  <!-- ====== MAIN DASHBOARD ====== -->
  <main class="dashboard-container" id="dashboardPanel">

    <!-- Hero: Score Card + Map -->
    <section class="hero-section">
      <!-- Left: Score Card -->
      <div class="hero-score-card" id="heroCard">
        <div class="hero-placeholder" id="heroPlaceholder">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
            <path d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"/>
          </svg>
          <p>Select a state or city to view its MOI</p>
        </div>
        <div id="heroContent" style="display:none; width:100%; text-align:center;">
          <div class="hero-state-name" id="heroStateLabel">STATE</div>
          <div class="hero-state-full" id="heroStateFull">Select a State</div>
          <div class="hero-moi-score" id="heroMOI">--</div>
          <div class="hero-moi-label">MOI Score</div>
          <div class="hero-band" id="heroBand">--</div>
          <div class="hero-rank" id="heroRank">Rank: <span>--</span> of 50</div>
          <div class="hero-components" id="heroComponents">
            <div class="hero-comp-item"><span class="comp-label">Market Size</span><span class="comp-value" id="heroMSS">--</span></div>
            <div class="hero-comp-item"><span class="comp-label">Opportunity Gap</span><span class="comp-value" id="heroCDS">--</span></div>
            <div class="hero-comp-item"><span class="comp-label">Pest Risk</span><span class="comp-value" id="heroPRS">--</span></div>
            <div class="hero-comp-item"><span class="comp-label">Growth</span><span class="comp-value" id="heroGTS">--</span></div>
          </div>
        </div>
      </div>

      <!-- Right: Map -->
      <div class="map-container">
        <h2>U.S. Market Opportunity</h2>
        <p class="map-subtitle" id="mapSubtitle">Click a state to drill into its expansion profile</p>
        <div id="us-map"></div>
        <div class="map-legend" id="mapLegend"></div>
      </div>
    </section>

    <!-- Ranked Opportunity Table -->
    <section>
      <div class="section-header">
        <h2>Ranked Opportunity Table</h2>
        <p id="tableSubtitle">All 50 states ranked by composite MOI score</p>
      </div>
      <div class="table-section">
        <div class="table-header">
          <h3 id="tableTitle">50 States - 2025</h3>
          <input type="text" class="table-search" id="tableSearch" placeholder="Search state...">
        </div>
        <div class="table-wrapper">
          <table class="data-table" id="stateTable">
            <thead>
              <tr>
                <th data-col="rank">Rank <span class="info-icon" data-metric="rank">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="state">State <span class="sort-icon">▲</span></th>
                <th data-col="moi">MOI <span class="info-icon" data-metric="moi">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="mss">Market Size <span class="info-icon" data-metric="mss">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="cds">Opportunity Gap <span class="info-icon" data-metric="cds">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="prs">Pest Risk <span class="info-icon" data-metric="prs">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="gts">Growth <span class="info-icon" data-metric="gts">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="population">Population <span class="info-icon" data-metric="population">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="pest_firm_count">Firms <span class="info-icon" data-metric="pest_firm_count">?</span> <span class="sort-icon">▲</span></th>
                <th data-col="comp_density">Per 100K <span class="info-icon" data-metric="comp_density">?</span> <span class="sort-icon">▲</span></th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ====== EXECUTIVE INTELLIGENCE ====== -->
    <section>
      <div class="section-header">
        <h2>Executive Intelligence</h2>
        <p>CEO-level market signals — opportunity, competition, and acquisition targets</p>
      </div>
      <div class="charts-grid">
        <!-- Row 1A: Opportunity vs Competition Bubble -->
        <div class="chart-card">
          <h3>Opportunity vs Competition <span class="info-icon" data-metric="oppBubble">?</span></h3>
          <p class="chart-subtitle">MOI score vs. firms per 100K — bubble size = population · Top 15 labeled</p>
          <div class="chart-canvas-container">
            <canvas id="oppBubbleChart"></canvas>
          </div>
        </div>

        <!-- Row 1B: Saturation Risk Meter -->
        <div class="chart-card gauge-card">
          <h3>Saturation Risk Meter <span class="info-icon" data-metric="satGauge">?</span></h3>
          <p class="chart-subtitle">Market entry recommendation for selected market</p>
          <div id="gaugeContainer">
            <div class="gauge-placeholder" id="gaugePlaceholder">
              <p>Select a market to see its saturation rating</p>
            </div>
            <div id="gaugeContent" style="display:none;">
              <div class="gauge-canvas-wrapper">
                <canvas id="satGaugeChart"></canvas>
              </div>
              <div class="gauge-label-row">
                <span class="gauge-zone-label" id="gaugeZoneLabel">--</span>
                <span class="gauge-density-value" id="gaugeDensityValue">-- firms/100K</span>
              </div>
              <div class="gauge-zone-legend">
                <span class="gauge-zone-dot" style="background:#16a34a;"></span>ENTER (&lt;8)
                <span class="gauge-zone-dot" style="background:#3b82f6;"></span>ACQUIRE (8-18)
                <span class="gauge-zone-dot" style="background:#ca8a04;"></span>DEFEND (18-30)
                <span class="gauge-zone-dot" style="background:#dc2626;"></span>EXIT (&gt;30)
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2A: Opportunity Gap Bar -->
        <div class="chart-card">
          <h3>Opportunity Gap Analysis <span class="info-icon" data-metric="oppGapBar">?</span></h3>
          <p class="chart-subtitle">Green = open market · Red = oversaturated</p>
          <div class="chart-canvas-container bar-chart-container">
            <canvas id="oppGapBarChart"></canvas>
          </div>
        </div>

        <!-- Row 2B: Acquisition Target Finder -->
        <div class="chart-card">
          <h3>Acquisition Target Finder <span class="info-icon" data-metric="acqTarget">?</span></h3>
          <p class="chart-subtitle">High opportunity despite high competition — enter via acquisition</p>
          <div class="chart-canvas-container bar-chart-container">
            <canvas id="acqTargetChart"></canvas>
          </div>
        </div>

        <!-- Row 3A: Component Breakdown (KEPT) -->
        <div class="chart-card breakdown-card">
          <h3>Component Breakdown</h3>
          <p class="chart-subtitle" id="breakdownSubtitle">Select a state to view weighted contributions</p>
          <div class="breakdown-bar-group" id="breakdownBars"></div>
        </div>

        <!-- Row 3B: MOI Distribution (KEPT) -->
        <div class="chart-card">
          <h3>MOI Distribution <span class="info-icon" data-metric="histogram">?</span></h3>
          <p class="chart-subtitle">Score distribution across all markets</p>
          <div class="chart-canvas-container">
            <canvas id="histogramChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- ====== PEST ACTIVITY INTELLIGENCE ====== -->
    <section>
      <div class="section-header">
        <h2>Pest Activity Intelligence</h2>
        <p>Orkin 2025 Top 50 city rankings — identifying where pest demand is highest</p>
      </div>
      <div class="pest-intel-grid">
        <!-- Row 1A: Pest Pressure vs Growth Bubble -->
        <div class="chart-card">
          <h3>Pest Pressure vs Growth <span class="info-icon" data-metric="pestGrowthBubble">?</span></h3>
          <p class="chart-subtitle">Bubble size = MOI score · Top 10 labeled · Only markets with pest data</p>
          <div class="chart-canvas-container">
            <canvas id="pestGrowthBubbleChart"></canvas>
          </div>
        </div>

        <!-- Row 1B: Pest Category Breakdown (KEPT) -->
        <div class="chart-card pest-breakdown-card">
          <h3>Pest Category Breakdown</h3>
          <p class="chart-subtitle" id="pestBreakdownSubtitle">Select a state to view pest pressure by category</p>
          <div id="pestBreakdownContent">
            <div class="pest-placeholder" id="pestPlaceholder">
              <p>Click a state on the map or table to see its pest activity profile</p>
            </div>
            <div id="pestDetail" style="display:none;">
              <div class="pest-score-header">
                <span class="pest-score-label">Pest Pressure Score</span>
                <span class="pest-score-value" id="pestScoreValue">--</span>
                <span class="pest-score-max">/ 100</span>
              </div>
              <div class="pest-bars" id="pestCategoryBars"></div>
              <div class="pest-cities-section">
                <h4>Top Ranked Cities in State</h4>
                <div id="pestCityList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 2A: State/City Comparison -->
        <div class="chart-card mini-map-card">
          <h3 id="compareCardTitle">State Comparison <span class="info-icon" data-metric="expansionMap">?</span></h3>
          <p class="chart-subtitle" id="compareCardSubtitle">Compare two states side-by-side across all key metrics</p>
          <div class="state-compare-selectors">
            <select id="compareStateA" class="compare-select">
              <option value="">Select State A</option>
            </select>
            <span class="compare-vs">vs</span>
            <select id="compareStateB" class="compare-select">
              <option value="">Select State B</option>
            </select>
          </div>
          <div id="stateCompareBody" class="state-compare-body"></div>
        </div>

        <!-- Row 2B: Underserved Markets Table -->
        <div class="chart-card">
          <h3>Underserved Markets <span class="info-icon" data-metric="compDensityTable">?</span></h3>
          <p class="chart-subtitle">Markets with &lt;50 firms per 100K — sorted by MOI</p>
          <div class="comp-density-table-wrapper" id="compDensityTableWrapper">
            <table class="comp-density-table" id="compDensityTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Market</th>
                  <th>Per 100K</th>
                  <th>MOI</th>
                  <th>Pest</th>
                  <th>Growth%</th>
                </tr>
              </thead>
              <tbody id="compDensityTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Row 3A: Top 15 by Pest Pressure (KEPT) -->
        <div class="chart-card pest-ranking-card">
          <h3>Top 15 by Pest Pressure <span class="info-icon" data-metric="pestRanking">?</span></h3>
          <p class="chart-subtitle">States with the most Orkin-ranked city appearances</p>
          <div class="chart-canvas-container">
            <canvas id="pestRankingChart"></canvas>
          </div>
        </div>

        <!-- Row 3B: Pest Heatmap (KEPT) -->
        <div class="chart-card pest-heatmap-card">
          <h3>Pest Pressure by Category <span class="info-icon" data-metric="pestHeatmap">?</span></h3>
          <p class="chart-subtitle">Score breakdown across 4 major pest categories (top 20 states)</p>
          <div class="pest-heatmap-wrapper">
            <table class="pest-heatmap-table" id="pestHeatmapTable">
              <thead>
                <tr>
                  <th>State</th>
                  <th>Total</th>
                  <th class="pest-col-mosquito">Mosquitoes</th>
                  <th class="pest-col-bedbug">Bed Bugs</th>
                  <th class="pest-col-termite">Termites</th>
                  <th class="pest-col-rodent">Rodents</th>
                </tr>
              </thead>
              <tbody id="pestHeatmapBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Sources & Methodology -->
    <section>
      <div class="section-header">
        <h2>Sources & Research Methodology</h2>
        <p>How the Market Opportunity Index is calculated</p>
      </div>
      <div class="methodology-grid">
        <div class="methodology-card">
          <h3>Scoring Formula</h3>
          <p>Each market receives a composite MOI score (0-100) calculated as a weighted sum of four normalized component scores:</p>
          <div class="formula-block">
            MOI = (0.35 x Market Size) + (0.30 x Opportunity Gap) + (0.20 x Pest Risk) + (0.15 x Growth)
          </div>
          <p>Each component is normalized using anchor-based scaling, producing scores from 0 (worst) to 100 (best).</p>
        </div>
        <div class="methodology-card">
          <h3>Component Definitions</h3>
          <ul class="methodology-list">
            <li><strong>Market Size (35%)</strong>: Total addressable market based on population. Larger populations indicate more potential residential and commercial customers.</li>
            <li><strong>Opportunity Gap (30%)</strong>: How much room exists for a new pest control company. Markets with fewer firms per resident score higher because there are more potential customers per competitor.</li>
            <li><strong>Pest Risk (20%)</strong>: Structural pest vulnerability based on housing age (% of units built before 1994) combined with climate conditions (temperature, humidity, precipitation) that favor pest activity.</li>
            <li><strong>Growth (15%)</strong>: Year-over-year population growth rate. Growing populations drive new housing construction and expanding demand for pest services.</li>
          </ul>
        </div>
        <div class="methodology-card">
          <h3>Data Sources</h3>
          <ul class="methodology-list">
            <li><strong>Population</strong>: U.S. Census Bureau, Population Estimates Program (PEP), Vintage 2025 (released Jan 2026)</li>
            <li><strong>Pest Control Firms (states)</strong>: U.S. Census Bureau, County Business Patterns (CBP), NAICS 561710 (Exterminating and Pest Control Services)</li>
            <li><strong>Pest Control Firms (cities)</strong>: Google Places API search within city boundaries, reflecting what customers find when searching for a local exterminator</li>
            <li><strong>Housing Age</strong>: U.S. Census Bureau, American Community Survey (ACS) 5-Year Estimates, Table B25034 (Year Structure Built)</li>
            <li><strong>Climate Risk</strong>: Composite index from NOAA Climate Normals (temperature, humidity, precipitation) and FEMA National Risk Index</li>
            <li><strong>Population Growth</strong>: Derived from year-over-year Census PEP estimates</li>
            <li><strong>Pest Activity</strong>: Orkin 2025 Top 50 City Rankings for Mosquitoes, Bed Bugs, Termites, and Rodents. Based on new residential treatments performed. Cities aggregated to state level.</li>
          </ul>
        </div>
        <div class="methodology-card">
          <h3>Opportunity Bands</h3>
          <ul class="methodology-list band-list">
            <li><span class="band-dot" style="background:#0f766e;"></span> <strong>80-100: High Expansion Opportunity</strong>: Large underserved markets with strong structural demand drivers</li>
            <li><span class="band-dot" style="background:#16a34a;"></span> <strong>60-79: Strong Opportunity</strong>: Favorable market dynamics with manageable competition</li>
            <li><span class="band-dot" style="background:#ca8a04;"></span> <strong>40-59: Moderate Opportunity</strong>: Balanced markets requiring targeted entry strategy</li>
            <li><span class="band-dot" style="background:#ea580c;"></span> <strong>20-39: Competitive / Saturated</strong>: High firm density relative to market size</li>
            <li><span class="band-dot" style="background:#dc2626;"></span> <strong>0-19: Highly Saturated</strong>: Very limited expansion potential under current conditions</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Tooltip -->
  <div class="map-tooltip" id="mapTooltip">
    <div class="tt-state"></div>
    <div class="tt-moi"></div>
    <div class="tt-row"><span class="tt-label">Rank</span><span class="tt-value tt-rank"></span></div>
    <div class="tt-row"><span class="tt-label">Population</span><span class="tt-value tt-pop"></span></div>
    <div class="tt-row"><span class="tt-label">Opportunity Gap</span><span class="tt-value tt-comp"></span></div>
  </div>

  <!-- Libraries -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Application -->
  <script src="data.js"></script>
  <script src="city_data.js"></script>
  <script src="pest_data.js"></script>
  <script src="engine.js"></script>
  <script src="climate.js"></script>
  <script src="app.js"></script>
</body>
</html>
